<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration</title>
    <style>
        body {
            background-color: #f4f4f4;
            padding: 0;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .projectName1, .projectName2, .projectName3 {
            color: white;
            font-size: 2.5em;
            font-weight: bold;
            margin-top: 0;
            text-align: center;
            margin-left: 5%;
        }
        .ProjectName {
            display: flex;
            flex-direction: column;
            margin-left: 25%;
        }
        .Logo {
            display: flex;
            flex-direction: row;
            background-color: #0568A1;
            width: 98.6%;
            height: auto;
            border: 1px solid black;
            padding: 10px; /* Add padding to provide spacing around content */
        }
        .Logo img {
            max-width: 30%;
            height: auto;
            margin-bottom: 10px; /* Add margin to separate image from text */
        }
        .Navbar {
            display: flex;
            padding: 1%;
            background-color: #0568A1;
        }
        .Navbar button {
            padding: 1%;
            color: white;
            background-color: #0568A1;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color 0.3s;
        }
        .Navbar button:hover {
            background-color: #777;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 40px 40px;
        }
        .controls label {
            margin-right: 20px;
        }
        .controls select,
        .controls button {
            padding: 5px 10px;
            margin-right: 10px;
        }
        .serial-monitor {
            margin-top: 40px;
            width: 90%;
            height: 200px;
            overflow-y: auto;
            margin-left: auto;
            margin-right: auto;
        }
        #monitor {
            width: 100%;
            height: 100%;
            padding: 20px;
            border: 2px solid #ccc;
            border-radius: 5px;
            resize: none;
            overflow-y: auto;
        }
        @media (max-width: 600px) {
            .Navbar {
                flex-direction: column;
                padding: 1%;
            }


            .Navbar button {
                margin-bottom: 10px;
                width: 100%;
                padding: 10px;
                font-size: 1.2em;
            }

            .Logo {
                flex-direction: column;
                width: 94%;
            }
            #connect{
                    margin-left: -142%;
                    margin-top: 29%;
            }
            #disconnect{
                    margin-top: 28%;
            }
            .controls{
            flex-flow : wrap;
            }
            .Logo img{
               max-width: 100%;
            }

            .ProjectName {
                margin: 0;
                flex-direction: row;
                gap: 8px;
            }

            .projectName1, .projectName2, .projectName3 {
                font-size: 1.8em;
                margin: 5px 0;
            }

        }

        @media (min-width: 601px) and (max-width: 900px) {
            .Navbar {
                flex-direction: row;
                padding: 1%;
                justify-content: space-around;
            }

            .Navbar button {
                padding: 10px 20px;
                font-size: 1.4em;
                margin: 0 10px;
            }

            .Logo {
                justify-content: space-between;
                padding: 10px 20px;
            }

            .ProjectName {
                margin: 0;
            }

            .projectName1, .projectName2, .projectName3 {
                font-size: 2em;
                margin: 0;
            }
        }
        @media (min-width: 901px) {
            .Navbar {
                padding: 1.5%;
            }
            .Navbar button {
                padding: 1%;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
<div class="Navbar">
    <button onclick="home()">Home</button>
    <button onclick="config()">Config</button>
</div>
<div class="Logo">
    <img src="https://www.drdo.gov.in/drdo/sites/default/files/drdo_logo_0.png?w=100" alt="Logo">
    <div class="ProjectName">
        <div class="projectName1">Acoustic</div>
        <div class="projectName2">Direction</div>
        <div class="projectName3">Finder</div>
    </div>
</div>
<div class="controls">
    <label for="bit-rate">Bit Rate:</label>
    <select id="bit-rate">
        <option value="9600">9600</option>
        <option value="14400">14400</option>
        <option value="19200">19200</option>
    </select>
    <button id="connect">Connect</button>
    <button id="disconnect" disabled>Disconnect</button>
</div>
<div class="serial-monitor">
    <textarea id="monitor" readonly></textarea>
</div>
<script>
let port = null;
let reader = null;
let writer = null;
let bitRate = '';

async function home() {
    window.location.href = "/";
}

async function config() {
    window.location.href = "Config";
}

document.getElementById('connect').addEventListener('click', async () => {
    const monitor = document.getElementById('monitor');
    bitRate = document.getElementById('bit-rate').value;

    try {
        // Prompt the user to select a port
        port = await navigator.serial.requestPort();

        if (port && bitRate) {
            // Open the port with the selected bit rate
            await port.open({ baudRate: parseInt(bitRate) });

            // Initialize reader and writer
            reader = port.readable.getReader();
            writer = port.writable.getWriter();

            monitor.value += `Connected successfully at ${bitRate} baud.\n`;
            monitor.scrollTop = monitor.scrollHeight; // Auto-scroll to bottom

            // Start reading data
            readLoop();

            document.getElementById('disconnect').disabled = false;
        } else {
            monitor.value += 'Please select a COM Port and Bit Rate.\n';
            monitor.scrollTop = monitor.scrollHeight;
        }
    } catch (error) {
        monitor.value += `Error connecting: ${error.message}\n`;
        monitor.scrollTop = monitor.scrollHeight;
    }
});

async function readLoop() {
    while (port.readable) {
        try {
            const { value, done } = await reader.read();
            if (done) {
                break;
            }
            const decodedData = new TextDecoder().decode(value);
            document.getElementById('monitor').value += `Data received: ${decodedData}\n`;

            // Send the decoded data to the backend
            await sendDataToBackend(decodedData);

            document.getElementById('monitor').scrollTop = document.getElementById('monitor').scrollHeight;
        } catch (error) {
            console.error('Error reading data:', error);
            break;
        }
    }
}

async function sendDataToBackend(data) {
    try {
        const response = await fetch('/api/serial-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ data: data }),
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const responseData = await response.text();
        console.log('Response from backend:', responseData);
    } catch (error) {
        console.error('Error sending data to backend:', error);
    }
}


document.getElementById('disconnect').addEventListener('click', async () => {
    try {
        if (reader) {
            await reader.cancel();
            reader.releaseLock();
        }
        if (writer) {
            await writer.releaseLock();
        }
        if (port && port.opened) {
            await port.close();
        }
        document.getElementById('disconnect').disabled = true;
        document.getElementById('monitor').value += 'Disconnected successfully.\n';
        document.getElementById('monitor').scrollTop = document.getElementById('monitor').scrollHeight;
    } catch (error) {
        document.getElementById('monitor').value += `Error disconnecting: ${error.message}\n`;
        document.getElementById('monitor').scrollTop = document.getElementById('monitor').scrollHeight;
    }
});
</script>
</html>